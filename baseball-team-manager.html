<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°‘å¹´é‡çƒãƒãƒ¼ãƒ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS for Excel file handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-section {
            padding: 40px;
            text-align: center;
        }

        .login-section h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .role-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .role-button {
            padding: 20px 40px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            font-weight: bold;
        }

        .role-button.parent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .role-button.admin {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .role-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .name-select-section {
            padding: 40px;
        }

        .name-select-section select {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 20px auto;
            display: block;
        }

        .main-content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            color: #666;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-logout {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .summary-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .summary-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .assignment-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .assignment-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            background: white;
        }

        .assignment-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .flex-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¾ å°‘å¹´é‡çƒãƒãƒ¼ãƒ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰äºˆå®šãƒ»å½“ç•ªç®¡ç†</p>
            <button class="btn-logout" id="logoutBtn" style="display: none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginSection" class="login-section">
            <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <div class="role-buttons">
                <button class="role-button parent" onclick="selectRole('parent')">
                    ä¿è­·è€…ã¨ã—ã¦å…¥åŠ›
                </button>
                <button class="role-button admin" onclick="selectRole('admin')">
                    ç®¡ç†è€…ã¨ã—ã¦å…¥åŠ›
                </button>
            </div>
        </div>

        <!-- åå‰é¸æŠç”»é¢ -->
        <div id="nameSelectSection" class="name-select-section" style="display: none;">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
            <select id="nameSelect" onchange="handleNameSelect()">
                <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
            </select>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="showLogin()">æˆ»ã‚‹</button>
            </div>
        </div>

        <!-- ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ -->
        <div id="adminPasswordSection" class="name-select-section" style="display: none;">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <div style="max-width: 400px; margin: 0 auto;">
                <div class="form-group">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="adminPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" 
                           style="width: 100%; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px;"
                           onkeypress="if(event.key === 'Enter') loginAsAdmin()">
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="loginAsAdmin()" style="padding: 15px 40px; font-size: 16px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="showLogin()">æˆ»ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="mainContent" class="main-content" style="display: none;">
            <!-- ã‚¿ãƒ– -->
            <div class="tabs" id="tabButtons"></div>

            <!-- ä¿è­·è€…ç”¨ï¼šå¸Œæœ›æ—¥å…¥åŠ› -->
            <div id="parentTab" class="tab-content">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">å½“ç•ªå¸Œæœ›æ—¥å…¥åŠ›</h2>
                <p class="info-text">ç®¡ç†è€…ãŒè¨­å®šã—ãŸæœˆã®å¸Œæœ›æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                
                <input type="month" id="parentMonth" style="display: none;">

                <div id="parentFormContent"></div>
            </div>

            <!-- ç®¡ç†è€…ç”¨ã‚¿ãƒ– -->
            <div id="practiceTab" class="tab-content">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">ç·´ç¿’æ—¥ç®¡ç†</h2>
                <p class="info-text">åœŸæ—¥ç¥æ—¥ã‹ã‚‰ç·´ç¿’ã‚’è¡Œã‚ãªã„æ—¥ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚ä¿è­·è€…ã®å¸Œæœ›æ—¥å…¥åŠ›ç”»é¢ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
                
                <div class="form-group">
                    <label>å¯¾è±¡æœˆã‚’é¸æŠ</label>
                    <input type="month" id="practiceManageMonth" onchange="loadPracticeDayManagement()">
                </div>

                <div id="practiceDayContent"></div>
            </div>

            <div id="groundTab" class="tab-content">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ä½¿ç”¨äºˆå®š</h2>
                
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="groundDate">
                </div>
                <div class="form-group">
                    <label>ä½¿ç”¨æ™‚é–“ï¼ˆé–‹å§‹ï¼‰</label>
                    <input type="time" id="groundTimeStart">
                </div>
                <div class="form-group">
                    <label>ä½¿ç”¨æ™‚é–“ï¼ˆçµ‚äº†ï¼‰</label>
                    <input type="time" id="groundTimeEnd">
                </div>
                <div class="form-group">
                    <label>å ´æ‰€</label>
                    <input type="text" id="groundLocation" placeholder="ä¾‹ï¼šã€‡ã€‡ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰">
                </div>
                <button class="btn btn-primary" onclick="addGround()">è¿½åŠ </button>

                <div id="groundList"></div>
            </div>

            <div id="vehicleTab" class="tab-content">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">è»Šä¸¡æƒ…å ±ç®¡ç†</h2>
                
                <div class="form-group">
                    <label>ä¿è­·è€…å</label>
                    <select id="vehicleParent"></select>
                </div>
                <div class="form-group">
                    <label>ä¹—è»Šå¯èƒ½äººæ•°ï¼ˆé‹è»¢æ‰‹ã‚’é™¤ãï¼‰</label>
                    <input type="number" id="vehicleCapacity" min="1" max="10" value="4">
                </div>
                <button class="btn btn-primary" onclick="addVehicle()">è¿½åŠ </button>

                <div id="vehicleList"></div>
            </div>

            <div id="absenceTab" class="tab-content">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">éƒ¨å“¡æ¬ å¸­ç®¡ç†</h2>
                
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="absenceDate">
                </div>
                <div class="form-group">
                    <label>æ¬ å¸­ã™ã‚‹éƒ¨å“¡</label>
                    <div class="checkbox-group" id="absenceMemberCheckboxes"></div>
                </div>
                <button class="btn btn-primary" onclick="addAbsence()">ç™»éŒ²</button>

                <div id="absenceList"></div>
            </div>

            <div id="assignmentTab" class="tab-content">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">å½“ç•ªå‰²ã‚Šå½“ã¦ç®¡ç†</h2>
                
                <div class="form-group">
                    <label>å¯¾è±¡æœˆã‚’é¸æŠ</label>
                    <input type="month" id="assignmentMonth" onchange="loadAssignmentView()">
                </div>

                <div id="assignmentContent"></div>
            </div>

            <div id="carAssignmentTab" class="tab-content">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">è»Šä¸¡å‰²ã‚Šå½“ã¦ç®¡ç†</h2>
                
                <div class="form-group">
                    <label>å¯¾è±¡æœˆã‚’é¸æŠ</label>
                    <input type="month" id="carAssignmentMonth" onchange="loadCarAssignmentView()">
                </div>

                <div id="carAssignmentContent"></div>
            </div>

            <div id="scheduleTab" class="tab-content">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">ç·åˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨</h2>
                
                <div class="form-group">
                    <label>è¡¨ç¤ºæœˆã‚’é¸æŠ</label>
                    <input type="month" id="scheduleMonth" onchange="loadScheduleView()">
                </div>

                <div id="scheduleContent"></div>
            </div>

            <div id="settingsTab" class="tab-content">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">åŸºæœ¬è¨­å®š</h2>
                
                <div class="summary-card">
                    <h3>ğŸ”¥ Firebaseé€£æºè¨­å®š</h3>
                    <div id="firebaseStatus"></div>
                    <p class="info-text">Firebaseé€£æºã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ä¿è­·è€…ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åé›†ã§ãã¾ã™ã€‚</p>
                    
                    <div class="form-group">
                        <label>ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ¢ãƒ¼ãƒ‰</label>
                        <select id="storageMode" onchange="changeStorageMode()" style="width: 100%; padding: 10px;">
                            <option value="local">ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼ˆå„è‡ªã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼‰</option>
                            <option value="firebase">Firebaseé€£æºï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã§å…±æœ‰ï¼‰</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="syncFromFirebase()" id="syncButton" style="display: none;">Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
                    <button class="btn btn-success" onclick="testFirebaseConnection()" style="margin-left: 10px;">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                </div>

                <div class="summary-card">
                    <h3>ä¿è­·è€…å…¥åŠ›å—ä»˜æœˆã®è¨­å®š</h3>
                    <p class="info-text">ä¿è­·è€…ãŒå¸Œæœ›æ—¥ã‚’å…¥åŠ›ã§ãã‚‹æœˆã‚’è¨­å®šã—ã¾ã™ã€‚æŒ‡å®šã—ãŸæœˆã®ã¿å…¥åŠ›å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
                    <div class="form-group">
                        <label>å…¥åŠ›å—ä»˜å¯¾è±¡æœˆ</label>
                        <input type="month" id="inputTargetMonth">
                    </div>
                    <button class="btn btn-primary" onclick="setInputTargetMonth()">è¨­å®šã™ã‚‹</button>
                    <button class="btn btn-danger" onclick="clearInputTargetMonth()" style="margin-left: 10px;">å—ä»˜ã‚’åœæ­¢</button>
                    <div id="currentInputTargetMonth" style="margin-top: 15px;"></div>
                </div>

                <div class="summary-card">
                    <h3>ä¿è­·è€…åç°¿</h3>
                    <div class="form-group">
                        <label>Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</label>
                        <input type="file" id="parentExcelFile" accept=".xlsx,.xls,.csv" style="margin-bottom: 10px;">
                        <button class="btn btn-primary" onclick="importParentsFromExcel()">Excelã‹ã‚‰èª­ã¿è¾¼ã¿</button>
                        <p class="info-text">â€»Excelãƒ•ã‚¡ã‚¤ãƒ«ã®1åˆ—ç›®ã«ä¿è­·è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒã‚ã‚‹å ´åˆã¯2è¡Œç›®ã‹ã‚‰ï¼‰</p>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label>ä¿è­·è€…åã‚’å€‹åˆ¥ã«è¿½åŠ </label>
                        <input type="text" id="newParentName" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ">
                        <button class="btn btn-primary" onclick="addParent()" style="margin-top: 10px;">è¿½åŠ </button>
                    </div>
                    <div id="parentList"></div>
                </div>

                <div class="summary-card">
                    <h3>éƒ¨å“¡åç°¿</h3>
                    <div class="form-group">
                        <label>Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</label>
                        <input type="file" id="memberExcelFile" accept=".xlsx,.xls,.csv" style="margin-bottom: 10px;">
                        <button class="btn btn-primary" onclick="importMembersFromExcel()">Excelã‹ã‚‰èª­ã¿è¾¼ã¿</button>
                        <p class="info-text">â€»Excelãƒ•ã‚¡ã‚¤ãƒ«ã®1åˆ—ç›®ã«éƒ¨å“¡åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒã‚ã‚‹å ´åˆã¯2è¡Œç›®ã‹ã‚‰ï¼‰</p>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label>éƒ¨å“¡åã‚’å€‹åˆ¥ã«è¿½åŠ </label>
                        <input type="text" id="newMemberName" placeholder="ä¾‹ï¼šå±±ç”°ä¸€éƒ">
                        <button class="btn btn-primary" onclick="addMember()" style="margin-top: 10px;">è¿½åŠ </button>
                    </div>
                    <div id="memberList"></div>
                </div>

                <div class="summary-card">
                    <h3>è¦ªå­é–¢ä¿‚ã®è¨­å®š</h3>
                    <p class="info-text">å„éƒ¨å“¡ã®ä¿è­·è€…ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚è»Šä¸¡å‰²ã‚Šå½“ã¦æ™‚ã«ã€è‡ªåˆ†ã®å­ä¾›ã¯è‡ªåˆ†ã®è»Šã«ä¹—ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
                    <div id="parentChildRelationList"></div>
                </div>

                <div class="summary-card">
                    <h3>åŒä¹—ã™ã‚‹å…„å¼Ÿå§‰å¦¹ã®äººæ•°</h3>
                    <p class="info-text">å„ä¿è­·è€…ãŒè»Šå½“ç•ªã®éš›ã«ä¸€ç·’ã«ä¹—ã‚‹ã€éƒ¨å“¡ã§ã¯ãªã„å…„å¼Ÿå§‰å¦¹ã®äººæ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                    <div id="siblingsCountList"></div>
                </div>

                <div class="summary-card">
                    <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                    <button class="btn btn-danger" onclick="clearAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
                    <p class="info-text">â€»æ³¨æ„ï¼šã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // Firebaseè¨­å®šï¼ˆç®¡ç†è€…ãŒè¨­å®šã—ã¦ãã ã•ã„ï¼‰
        // ==========================================
        
        const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAbyg-sZKbXghOpyDpTyoZ7HSqhiqr2Sgo",
  authDomain: "mutsumibaseball-manager.firebaseapp.com",
  projectId: "mutsumibaseball-manager",
  storageBucket: "mutsumibaseball-manager.firebasestorage.app",
  messagingSenderId: "216970276594",
  appId: "1:216970276594:web:0e04015ffd3af9a382aa6b"
};

        // FirebaseåˆæœŸåŒ–
        let db = null;
        let firebaseInitialized = false;

        function initializeFirebase() {
            if (!FIREBASE_CONFIG.apiKey) {
                console.log('Firebaseè¨­å®šãŒæœªè¨­å®šã§ã™');
                return false;
            }

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(FIREBASE_CONFIG);
                }
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log('FirebaseåˆæœŸåŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let currentRole = null;

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼
        const STORAGE_KEYS = {
            parents: 'baseball_parents',
            members: 'baseball_members',
            grounds: 'baseball_grounds',
            vehicles: 'baseball_vehicles',
            absences: 'baseball_absences',
            preferences: 'baseball_preferences',
            assignments: 'baseball_assignments',
            practice_days: 'baseball_practice_days',
            input_target_month: 'baseball_input_target_month',
            parent_child_relations: 'baseball_parent_child_relations',
            siblings_count: 'baseball_siblings_count',
            storage_mode: 'baseball_storage_mode' // 'local' or 'firebase'
        };

        // åˆæœŸåŒ–
        function init() {
            // FirebaseåˆæœŸåŒ–ã‚’è©¦è¡Œ
            initializeFirebase();
            
            // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸåŒ–
            if (!localStorage.getItem(STORAGE_KEYS.storage_mode)) {
                localStorage.setItem(STORAGE_KEYS.storage_mode, 'local');
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã®è¨­å®šï¼ˆåŒæœŸçš„ã«å®Ÿè¡Œï¼‰
            const existingParents = localStorage.getItem(STORAGE_KEYS.parents);
            const existingMembers = localStorage.getItem(STORAGE_KEYS.members);
            
            if (!existingParents) {
                localStorage.setItem(STORAGE_KEYS.parents, JSON.stringify(['å±±ç”°å¤ªéƒ', 'ä½è—¤èŠ±å­', 'éˆ´æœ¨ä¸€éƒ', 'ç”°ä¸­ç¾å’²', 'ç®¡ç†è€…']));
                console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¿è­·è€…ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã—ãŸ');
            }
            if (!existingMembers) {
                localStorage.setItem(STORAGE_KEYS.members, JSON.stringify(['éƒ¨å“¡A', 'éƒ¨å“¡B', 'éƒ¨å“¡C', 'éƒ¨å“¡D', 'éƒ¨å“¡E']));
                console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéƒ¨å“¡ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã—ãŸ');
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('logoutBtn').addEventListener('click', logout);
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»å–å¾—
        async function saveData(key, data) {
            const storageMode = localStorage.getItem(STORAGE_KEYS.storage_mode) || 'local';
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯å¸¸ã«ä¿å­˜
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
            }

            // Firebaseãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€Firestoreã«ã‚‚ä¿å­˜
            if (storageMode === 'firebase' && firebaseInitialized) {
                try {
                    await db.collection('baseball_data').doc(key).set({
                        data: data,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log(`Firebaseä¿å­˜æˆåŠŸ: ${key}`);
                } catch (error) {
                    console.error('Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    // Firebaseã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¦ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã«ã¯ä¿å­˜æ¸ˆã¿
                }
            }
        }

        async function getData(key) {
            const storageMode = localStorage.getItem(STORAGE_KEYS.storage_mode) || 'local';

            // Firebaseãƒ¢ãƒ¼ãƒ‰ã‹ã¤ä¿è­·è€…ã®å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã€Firebaseã‹ã‚‰å–å¾—
            if (storageMode === 'firebase' && firebaseInitialized && key === STORAGE_KEYS.preferences) {
                try {
                    const doc = await db.collection('baseball_data').doc(key).get();
                    if (doc.exists) {
                        return doc.data().data;
                    }
                } catch (error) {
                    console.error('Firebaseå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—
                }
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                return null;
            }
        }

        // ãƒ­ãƒ¼ãƒ«é¸æŠ
        async function selectRole(role) {
            currentRole = role;
            document.getElementById('loginSection').style.display = 'none';
            
            if (role === 'admin') {
                // ç®¡ç†è€…ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
                document.getElementById('adminPasswordSection').style.display = 'block';
            } else {
                // ä¿è­·è€…ã¯åå‰é¸æŠ
                document.getElementById('nameSelectSection').style.display = 'block';
                
                const select = document.getElementById('nameSelect');
                select.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
                
                // ä¿è­·è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆéåŒæœŸå¯¾å¿œï¼‰
                let parents = await getData(STORAGE_KEYS.parents);
                
                // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                if (!parents || parents.length === 0) {
                    console.log('ä¿è­·è€…ãƒ‡ãƒ¼ã‚¿ãŒç©ºãªã®ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã™');
                    parents = ['å±±ç”°å¤ªéƒ', 'ä½è—¤èŠ±å­', 'éˆ´æœ¨ä¸€éƒ', 'ç”°ä¸­ç¾å’²', 'ç®¡ç†è€…'];
                    await saveData(STORAGE_KEYS.parents, parents);
                }
                
                parents.forEach(parent => {
                    const option = document.createElement('option');
                    option.value = parent;
                    option.textContent = parent;
                    select.appendChild(option);
                });
                
                console.log('ä¿è­·è€…ãƒªã‚¹ãƒˆ:', parents);
            }
        }
        
        // ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ã‚°ã‚¤ãƒ³
        function loginAsAdmin() {
            const password = document.getElementById('adminPassword').value;
            const correctPassword = 'mutsumi2025'; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã“ã“ã‚’ç·¨é›†
            
            if (password === correctPassword) {
                currentUser = 'ç®¡ç†è€…';
                document.getElementById('adminPasswordSection').style.display = 'none';
                document.getElementById('appSection').style.display = 'block';
                loadAllData();
            } else {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                document.getElementById('adminPassword').value = '';
            }
        }

        // åå‰é¸æŠ
        function handleNameSelect() {
            const name = document.getElementById('nameSelect').value;
            if (name) {
                login(name);
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³
        function login(name) {
            currentUser = name;
            document.getElementById('nameSelectSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
            
            setupTabs();
            loadAllData();
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            currentUser = null;
            currentRole = null;
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            showLogin();
        }

        // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('nameSelectSection').style.display = 'none';
            document.getElementById('adminPasswordSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'none';
            currentUser = null;
            currentRole = null;
            document.getElementById('adminPassword').value = '';
        }

        // ã‚¿ãƒ–è¨­å®š
        function setupTabs() {
            const tabButtons = document.getElementById('tabButtons');
            tabButtons.innerHTML = '';

            const tabs = currentRole === 'admin' 
                ? [
                    { id: 'practice', label: 'ç·´ç¿’æ—¥ç®¡ç†' },
                    { id: 'ground', label: 'ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰äºˆå®š' },
                    { id: 'vehicle', label: 'è»Šä¸¡æƒ…å ±' },
                    { id: 'absence', label: 'æ¬ å¸­ç®¡ç†' },
                    { id: 'assignment', label: 'å½“ç•ªå‰²ã‚Šå½“ã¦' },
                    { id: 'carAssignment', label: 'è»Šä¸¡å‰²ã‚Šå½“ã¦' },
                    { id: 'schedule', label: 'ç·åˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«' },
                    { id: 'settings', label: 'è¨­å®š' }
                ]
                : [
                    { id: 'parent', label: 'å¸Œæœ›æ—¥å…¥åŠ›' }
                ];

            tabs.forEach((tab, index) => {
                const button = document.createElement('button');
                button.className = 'tab' + (index === 0 ? ' active' : '');
                button.textContent = tab.label;
                button.onclick = () => switchTab(tab.id);
                tabButtons.appendChild(button);
            });

            // æœ€åˆã®ã‚¿ãƒ–ã‚’è¡¨ç¤º
            switchTab(tabs[0].id);
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabId) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(button => {
                button.classList.remove('active');
            });

            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
            const tabContent = document.getElementById(tabId + 'Tab');
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            event.target.classList.add('active');

            // ã‚¿ãƒ–ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            if (tabId === 'practice') loadPracticeDayManagement();
            if (tabId === 'ground') loadGroundList();
            if (tabId === 'vehicle') loadVehicleList();
            if (tabId === 'absence') loadAbsenceList();
            if (tabId === 'settings') loadSettings();
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAllData() {
            if (currentRole === 'admin') {
                // å½“æœˆã‚’è‡ªå‹•è¨­å®š
                const now = new Date();
                const monthStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
                document.getElementById('practiceManageMonth').value = monthStr;
                loadPracticeDayManagement();
                loadGroundList();
                loadVehicleList();
                loadAbsenceList();
                loadSettings();
            } else {
                // ä¿è­·è€…ç”¨ï¼šç®¡ç†è€…ãŒè¨­å®šã—ãŸå¯¾è±¡æœˆã‚’èª­ã¿è¾¼ã¿
                await loadParentForm();
            }
        }

        // ç·´ç¿’æ—¥ç®¡ç†
        function loadPracticeDayManagement() {
            const month = document.getElementById('practiceManageMonth')?.value;
            if (!month) return;

            const [year, monthNum] = month.split('-').map(Number);
            const weekends = getWeekendsAndHolidays(year, monthNum);
            const practiceDays = getPracticeDays(month);

            let html = '<div class="summary-card">';
            html += '<p class="info-text">ç·´ç¿’ã‚’è¡Œã‚ãªã„æ—¥ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚ä¿è­·è€…ã¸ã®å¸Œæœ›æ—¥å…¥åŠ›ç”»é¢ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>';
            html += '<table style="margin-top: 15px;">';
            html += '<thead><tr><th>æ—¥ä»˜</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>';

            weekends.forEach(day => {
                const isActive = practiceDays.includes(day.date);
                const dateEscaped = day.date.replace(/-/g, '_');
                html += `<tr style="${!isActive ? 'background: #ffebee;' : ''}">`;
                html += `<td><strong>${day.display}</strong></td>`;
                html += `<td>${isActive ? 'âœ“ ç·´ç¿’æ—¥' : 'âœ— ç·´ç¿’ãªã—'}</td>`;
                html += `<td>`;
                if (isActive) {
                    html += `<button class="delete-btn practice-remove-btn" data-month="${month}" data-date="${day.date}">ç·´ç¿’ãªã—ã«å¤‰æ›´</button>`;
                } else {
                    html += `<button class="btn btn-success practice-add-btn" style="padding: 6px 12px; font-size: 14px;" data-month="${month}" data-date="${day.date}">ç·´ç¿’æ—¥ã«æˆ»ã™</button>`;
                }
                html += `</td>`;
                html += `</tr>`;
            });

            html += '</tbody></table></div>';
            
            document.getElementById('practiceDayContent').innerHTML = html;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.querySelectorAll('.practice-remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = this.getAttribute('data-month');
                    const date = this.getAttribute('data-date');
                    removePracticeDay(month, date);
                });
            });

            document.querySelectorAll('.practice-add-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = this.getAttribute('data-month');
                    const date = this.getAttribute('data-date');
                    addPracticeDay(month, date);
                });
            });
        }

        // ç·´ç¿’æ—¥ã‚’å‰Šé™¤
        function removePracticeDay(month, date) {
            if (!confirm('ã“ã®æ—¥ã‚’ç·´ç¿’ãªã—ã«ã—ã¾ã™ã‹ï¼Ÿ')) return;

            const practiceDays = getData(STORAGE_KEYS.practice_days) || {};
            if (practiceDays[month]) {
                practiceDays[month] = practiceDays[month].filter(d => d !== date);
                saveData(STORAGE_KEYS.practice_days, practiceDays);
            }

            loadPracticeDayManagement();
        }

        // ç·´ç¿’æ—¥ã‚’è¿½åŠ 
        function addPracticeDay(month, date) {
            const practiceDays = getData(STORAGE_KEYS.practice_days) || {};
            if (!practiceDays[month]) {
                practiceDays[month] = [];
            }
            if (!practiceDays[month].includes(date)) {
                practiceDays[month].push(date);
                practiceDays[month].sort();
                saveData(STORAGE_KEYS.practice_days, practiceDays);
            }

            loadPracticeDayManagement();
        }

        // ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è¿½åŠ 
        function addGround() {
            const date = document.getElementById('groundDate').value;
            const timeStart = document.getElementById('groundTimeStart').value;
            const timeEnd = document.getElementById('groundTimeEnd').value;
            const location = document.getElementById('groundLocation').value;

            if (!date || !timeStart || !timeEnd || !location) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const grounds = getData(STORAGE_KEYS.grounds) || [];
            grounds.push({ date, timeStart, timeEnd, location, id: Date.now() });
            saveData(STORAGE_KEYS.grounds, grounds);

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            document.getElementById('groundDate').value = '';
            document.getElementById('groundTimeStart').value = '';
            document.getElementById('groundTimeEnd').value = '';
            document.getElementById('groundLocation').value = '';

            loadGroundList();
        }

        // ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒªã‚¹ãƒˆè¡¨ç¤º
        function loadGroundList() {
            const grounds = getData(STORAGE_KEYS.grounds) || [];
            const listDiv = document.getElementById('groundList');

            if (grounds.length === 0) {
                listDiv.innerHTML = '<p class="info-text">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            grounds.sort((a, b) => new Date(a.date) - new Date(b.date));

            let html = '<table><thead><tr><th>æ—¥ä»˜</th><th>æ™‚é–“</th><th>å ´æ‰€</th><th>æ“ä½œ</th></tr></thead><tbody>';
            grounds.forEach(ground => {
                html += `
                    <tr>
                        <td>${ground.date}</td>
                        <td>${ground.timeStart} - ${ground.timeEnd}</td>
                        <td>${ground.location}</td>
                        <td><button class="delete-btn" onclick="deleteGround(${ground.id})">å‰Šé™¤</button></td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            listDiv.innerHTML = html;
        }

        // ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‰Šé™¤
        function deleteGround(id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            let grounds = getData(STORAGE_KEYS.grounds) || [];
            grounds = grounds.filter(g => g.id !== id);
            saveData(STORAGE_KEYS.grounds, grounds);
            loadGroundList();
        }

        // è»Šä¸¡è¿½åŠ 
        function addVehicle() {
            const parent = document.getElementById('vehicleParent').value;
            const capacity = parseInt(document.getElementById('vehicleCapacity').value);

            if (!parent) {
                alert('ä¿è­·è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const vehicles = getData(STORAGE_KEYS.vehicles) || [];
            
            // æ—¢å­˜ãƒã‚§ãƒƒã‚¯
            const existing = vehicles.find(v => v.parent === parent);
            if (existing) {
                if (!confirm('ã“ã®ä¿è­·è€…ã®è»Šä¸¡æƒ…å ±ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
                existing.capacity = capacity;
            } else {
                vehicles.push({ parent, capacity, id: Date.now() });
            }

            saveData(STORAGE_KEYS.vehicles, vehicles);
            document.getElementById('vehicleCapacity').value = 4;
            loadVehicleList();
        }

        // è»Šä¸¡ãƒªã‚¹ãƒˆè¡¨ç¤º
        function loadVehicleList() {
            const vehicles = getData(STORAGE_KEYS.vehicles) || [];
            const parents = getData(STORAGE_KEYS.parents) || [];
            
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹æ›´æ–°
            const select = document.getElementById('vehicleParent');
            select.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
            parents.forEach(parent => {
                const option = document.createElement('option');
                option.value = parent;
                option.textContent = parent;
                select.appendChild(option);
            });

            const listDiv = document.getElementById('vehicleList');

            if (vehicles.length === 0) {
                listDiv.innerHTML = '<p class="info-text">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹è»Šä¸¡æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            let html = '<table><thead><tr><th>ä¿è­·è€…å</th><th>ä¹—è»Šå¯èƒ½äººæ•°</th><th>æ“ä½œ</th></tr></thead><tbody>';
            vehicles.forEach(vehicle => {
                html += `
                    <tr>
                        <td>${vehicle.parent}</td>
                        <td>${vehicle.capacity}å</td>
                        <td><button class="delete-btn" onclick="deleteVehicle(${vehicle.id})">å‰Šé™¤</button></td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            listDiv.innerHTML = html;
        }

        // è»Šä¸¡å‰Šé™¤
        function deleteVehicle(id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            let vehicles = getData(STORAGE_KEYS.vehicles) || [];
            vehicles = vehicles.filter(v => v.id !== id);
            saveData(STORAGE_KEYS.vehicles, vehicles);
            loadVehicleList();
        }

        // æ¬ å¸­ç™»éŒ²
        function addAbsence() {
            const date = document.getElementById('absenceDate').value;
            const checkboxes = document.querySelectorAll('#absenceMemberCheckboxes input:checked');
            
            if (!date) {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (checkboxes.length === 0) {
                alert('æ¬ å¸­ã™ã‚‹éƒ¨å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const members = Array.from(checkboxes).map(cb => cb.value);
            
            const absences = getData(STORAGE_KEYS.absences) || [];
            
            // åŒã˜æ—¥ä»˜ã®æ¬ å¸­æƒ…å ±ã‚’å‰Šé™¤
            const filtered = absences.filter(a => a.date !== date);
            filtered.push({ date, members, id: Date.now() });
            
            saveData(STORAGE_KEYS.absences, filtered);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            document.getElementById('absenceDate').value = '';
            checkboxes.forEach(cb => cb.checked = false);
            
            loadAbsenceList();
        }

        // æ¬ å¸­ãƒªã‚¹ãƒˆè¡¨ç¤º
        function loadAbsenceList() {
            const absences = getData(STORAGE_KEYS.absences) || [];
            const members = getData(STORAGE_KEYS.members) || [];
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ›´æ–°
            const checkboxDiv = document.getElementById('absenceMemberCheckboxes');
            checkboxDiv.innerHTML = '';
            members.forEach(member => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = member;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(member));
                checkboxDiv.appendChild(label);
            });

            const listDiv = document.getElementById('absenceList');

            if (absences.length === 0) {
                listDiv.innerHTML = '<p class="info-text">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹æ¬ å¸­æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            absences.sort((a, b) => new Date(a.date) - new Date(b.date));

            let html = '<table><thead><tr><th>æ—¥ä»˜</th><th>æ¬ å¸­è€…</th><th>æ“ä½œ</th></tr></thead><tbody>';
            absences.forEach(absence => {
                html += `
                    <tr>
                        <td>${absence.date}</td>
                        <td>${absence.members.join(', ')}</td>
                        <td><button class="delete-btn" onclick="deleteAbsence(${absence.id})">å‰Šé™¤</button></td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            listDiv.innerHTML = html;
        }

        // æ¬ å¸­å‰Šé™¤
        function deleteAbsence(id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            let absences = getData(STORAGE_KEYS.absences) || [];
            absences = absences.filter(a => a.id !== id);
            saveData(STORAGE_KEYS.absences, absences);
            loadAbsenceList();
        }

        // åœŸæ—¥ç¥æ—¥ã‚’å–å¾—
        function getWeekendsAndHolidays(year, month) {
            const dates = [];
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // æ—¥æœ¬ã®ç¥æ—¥ï¼ˆ2024-2030å¹´å¯¾å¿œï¼‰
            const holidays = {
                // 2024å¹´
                '2024-01-01': 'å…ƒæ—¥',
                '2024-01-08': 'æˆäººã®æ—¥',
                '2024-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2024-02-12': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2024-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2024-03-20': 'æ˜¥åˆ†ã®æ—¥',
                '2024-04-29': 'æ˜­å’Œã®æ—¥',
                '2024-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2024-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2024-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2024-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2024-07-15': 'æµ·ã®æ—¥',
                '2024-08-11': 'å±±ã®æ—¥',
                '2024-08-12': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2024-09-16': 'æ•¬è€ã®æ—¥',
                '2024-09-22': 'ç§‹åˆ†ã®æ—¥',
                '2024-09-23': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2024-10-14': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2024-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2024-11-04': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2024-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                
                // 2025å¹´
                '2025-01-01': 'å…ƒæ—¥',
                '2025-01-13': 'æˆäººã®æ—¥',
                '2025-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2025-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2025-02-24': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2025-03-20': 'æ˜¥åˆ†ã®æ—¥',
                '2025-04-29': 'æ˜­å’Œã®æ—¥',
                '2025-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2025-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2025-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2025-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2025-07-21': 'æµ·ã®æ—¥',
                '2025-08-11': 'å±±ã®æ—¥',
                '2025-09-15': 'æ•¬è€ã®æ—¥',
                '2025-09-23': 'ç§‹åˆ†ã®æ—¥',
                '2025-10-13': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2025-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2025-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                '2025-11-24': 'æŒ¯æ›¿ä¼‘æ—¥',
                
                // 2026å¹´
                '2026-01-01': 'å…ƒæ—¥',
                '2026-01-12': 'æˆäººã®æ—¥',
                '2026-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2026-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2026-03-20': 'æ˜¥åˆ†ã®æ—¥',
                '2026-04-29': 'æ˜­å’Œã®æ—¥',
                '2026-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2026-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2026-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2026-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2026-07-20': 'æµ·ã®æ—¥',
                '2026-08-11': 'å±±ã®æ—¥',
                '2026-09-21': 'æ•¬è€ã®æ—¥',
                '2026-09-22': 'å›½æ°‘ã®ä¼‘æ—¥',
                '2026-09-23': 'ç§‹åˆ†ã®æ—¥',
                '2026-10-12': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2026-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2026-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                
                // 2027å¹´
                '2027-01-01': 'å…ƒæ—¥',
                '2027-01-11': 'æˆäººã®æ—¥',
                '2027-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2027-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2027-03-21': 'æ˜¥åˆ†ã®æ—¥',
                '2027-03-22': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2027-04-29': 'æ˜­å’Œã®æ—¥',
                '2027-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2027-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2027-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2027-07-19': 'æµ·ã®æ—¥',
                '2027-08-11': 'å±±ã®æ—¥',
                '2027-09-20': 'æ•¬è€ã®æ—¥',
                '2027-09-23': 'ç§‹åˆ†ã®æ—¥',
                '2027-10-11': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2027-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2027-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                
                // 2028å¹´
                '2028-01-01': 'å…ƒæ—¥',
                '2028-01-10': 'æˆäººã®æ—¥',
                '2028-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2028-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2028-03-20': 'æ˜¥åˆ†ã®æ—¥',
                '2028-04-29': 'æ˜­å’Œã®æ—¥',
                '2028-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2028-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2028-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2028-07-17': 'æµ·ã®æ—¥',
                '2028-08-11': 'å±±ã®æ—¥',
                '2028-09-18': 'æ•¬è€ã®æ—¥',
                '2028-09-22': 'ç§‹åˆ†ã®æ—¥',
                '2028-10-09': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2028-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2028-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                
                // 2029å¹´
                '2029-01-01': 'å…ƒæ—¥',
                '2029-01-08': 'æˆäººã®æ—¥',
                '2029-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2029-02-12': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2029-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2029-03-20': 'æ˜¥åˆ†ã®æ—¥',
                '2029-04-29': 'æ˜­å’Œã®æ—¥',
                '2029-04-30': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2029-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2029-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2029-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2029-07-16': 'æµ·ã®æ—¥',
                '2029-08-11': 'å±±ã®æ—¥',
                '2029-09-17': 'æ•¬è€ã®æ—¥',
                '2029-09-23': 'ç§‹åˆ†ã®æ—¥',
                '2029-09-24': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2029-10-08': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2029-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2029-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                
                // 2030å¹´
                '2030-01-01': 'å…ƒæ—¥',
                '2030-01-14': 'æˆäººã®æ—¥',
                '2030-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2030-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2030-03-20': 'æ˜¥åˆ†ã®æ—¥',
                '2030-04-29': 'æ˜­å’Œã®æ—¥',
                '2030-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2030-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2030-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2030-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2030-07-15': 'æµ·ã®æ—¥',
                '2030-08-11': 'å±±ã®æ—¥',
                '2030-08-12': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2030-09-16': 'æ•¬è€ã®æ—¥',
                '2030-09-23': 'ç§‹åˆ†ã®æ—¥',
                '2030-10-14': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2030-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2030-11-04': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2030-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥'
            };

            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay();
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // åœŸæ›œ(6)ã¾ãŸã¯æ—¥æ›œ(0)ã¾ãŸã¯ç¥æ—¥
                if (dayOfWeek === 0 || dayOfWeek === 6 || holidays[dateStr]) {
                    const dayName = dayNames[dayOfWeek];
                    const holidayName = holidays[dateStr] || '';
                    dates.push({
                        date: dateStr,
                        display: `${month}/${day}(${dayName})${holidayName ? ' ' + holidayName : ''}`
                    });
                }
            }
            
            return dates;
        }

        // ç·´ç¿’æ—¥ã‚’å–å¾—ãƒ»ç®¡ç†
        function getPracticeDays(month) {
            const practiceDays = getData(STORAGE_KEYS.practice_days) || {};
            if (!practiceDays[month]) {
                // åˆå›ã¯å…¨ã¦ã®åœŸæ—¥ç¥æ—¥ã‚’ç·´ç¿’æ—¥ã¨ã—ã¦è¨­å®š
                const [year, monthNum] = month.split('-').map(Number);
                const weekends = getWeekendsAndHolidays(year, monthNum);
                practiceDays[month] = weekends.map(w => w.date);
                saveData(STORAGE_KEYS.practice_days, practiceDays);
            }
            return practiceDays[month];
        }

        // ä¿è­·è€…ç”¨ãƒ•ã‚©ãƒ¼ãƒ èª­ã¿è¾¼ã¿
        async function loadParentForm() {
            const targetMonth = await getData(STORAGE_KEYS.input_target_month);
            
            if (!targetMonth) {
                document.getElementById('parentFormContent').innerHTML = 
                    '<p class="info-text" style="color: #e74c3c;">ç¾åœ¨ã€å…¥åŠ›å—ä»˜æœŸé–“å¤–ã§ã™ã€‚ç®¡ç†è€…ãŒå…¥åŠ›å¯èƒ½æœˆã‚’è¨­å®šã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚</p>';
                document.getElementById('parentMonth').value = '';
                document.getElementById('parentMonth').disabled = true;
                return;
            }

            // æœˆé¸æŠã‚’ç„¡åŠ¹åŒ–ã—ã€ç®¡ç†è€…æŒ‡å®šã®æœˆã®ã¿è¡¨ç¤º
            document.getElementById('parentMonth').value = targetMonth;
            document.getElementById('parentMonth').disabled = true;

            const month = targetMonth;
            const [year, monthNum] = month.split('-').map(Number);
            const weekends = getWeekendsAndHolidays(year, monthNum);
            const practiceDays = getPracticeDays(month);
            const activeDays = weekends.filter(w => practiceDays.includes(w.date));

            if (activeDays.length === 0) {
                document.getElementById('parentFormContent').innerHTML = 
                    '<p class="info-text">ã“ã®æœˆã®ç·´ç¿’æ—¥ã¯ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            const preferences = getData(STORAGE_KEYS.preferences) || {};
            const userPrefs = preferences[currentUser] || {};
            const monthPrefs = userPrefs[month] || {};

            let html = '<div class="summary-card">';
            html += `<h3>${year}å¹´${monthNum}æœˆã®å½“ç•ªå¯èƒ½æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>`;
            html += '<p class="info-text">å„æ—¥ä»˜ã«ã¤ã„ã¦ã€å½“ç•ªãŒå¯èƒ½ã‹ã©ã†ã‹ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
            html += '<table style="margin-top: 15px;">';
            html += '<thead><tr><th>æ—¥ä»˜</th><th>ãŠèŒ¶ãƒ»è»Šä¸¡</th></tr></thead><tbody>';

            activeDays.forEach(day => {
                const pref = monthPrefs[day.date] || 'not_available';
                html += `<tr>`;
                html += `<td><strong>${day.display}</strong></td>`;
                html += `<td>`;
                html += `<select id="pref_${day.date}" style="width: 100%; padding: 8px;">`;
                html += `<option value="both" ${pref === 'both' ? 'selected' : ''}>ãŠèŒ¶ã‚‚è»Šã‚‚å¯èƒ½</option>`;
                html += `<option value="tea_only" ${pref === 'tea_only' ? 'selected' : ''}>ãŠèŒ¶ã®ã¿å¯èƒ½</option>`;
                html += `<option value="car_only" ${pref === 'car_only' ? 'selected' : ''}>è»Šã®ã¿å¯èƒ½</option>`;
                html += `<option value="not_available" ${pref === 'not_available' ? 'selected' : ''}>ä¸å¯</option>`;
                html += `</select>`;
                html += `</td>`;
                html += `</tr>`;
            });

            html += '</tbody></table></div>';
            html += '<div class="success-message" style="display: none;" id="saveMessage">ä¿å­˜ã—ã¾ã—ãŸ</div>';
            html += '<button class="btn btn-success" onclick="saveParentPreference(true)">ä¿å­˜</button>';

            document.getElementById('parentFormContent').innerHTML = html;
        }

        // ä¿è­·è€…å¸Œæœ›ä¿å­˜
        function saveParentPreference(showMessage = false) {
            const month = getData(STORAGE_KEYS.input_target_month);
            if (!month) {
                alert('å…¥åŠ›å—ä»˜æœŸé–“å¤–ã§ã™');
                return;
            }

            const [year, monthNum] = month.split('-').map(Number);
            const weekends = getWeekendsAndHolidays(year, monthNum);
            const practiceDays = getPracticeDays(month);
            const activeDays = weekends.filter(w => practiceDays.includes(w.date));

            const preferences = getData(STORAGE_KEYS.preferences) || {};
            if (!preferences[currentUser]) {
                preferences[currentUser] = {};
            }
            if (!preferences[currentUser][month]) {
                preferences[currentUser][month] = {};
            }

            activeDays.forEach(day => {
                const select = document.getElementById(`pref_${day.date}`);
                if (select) {
                    preferences[currentUser][month][day.date] = select.value;
                }
            });

            saveData(STORAGE_KEYS.preferences, preferences);

            if (showMessage) {
                const msg = document.getElementById('saveMessage');
                if (msg) {
                    msg.style.display = 'block';
                    setTimeout(() => {
                        msg.style.display = 'none';
                    }, 3000);
                }
            }
        }

        // å½“ç•ªå‰²ã‚Šå½“ã¦è¡¨ç¤º
        function loadAssignmentView() {
            const month = document.getElementById('assignmentMonth').value;
            if (!month) return;

            const [year, monthNum] = month.split('-').map(Number);
            const weekends = getWeekendsAndHolidays(year, monthNum);
            const practiceDays = getPracticeDays(month);
            const activeDays = weekends.filter(w => practiceDays.includes(w.date));

            const preferences = getData(STORAGE_KEYS.preferences) || {};
            const assignments = getData(STORAGE_KEYS.assignments) || {};
            const parents = getData(STORAGE_KEYS.parents) || [];

            if (activeDays.length === 0) {
                document.getElementById('assignmentContent').innerHTML = 
                    '<p class="info-text">ã“ã®æœˆã®ç·´ç¿’æ—¥ã¯ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            const monthAssignments = assignments[month] || {};

            let html = '<button class="btn btn-success" onclick="autoAssign()" style="margin-bottom: 20px;">è‡ªå‹•å‰²ã‚Šå½“ã¦ææ¡ˆ</button>';
            html += '<div class="assignment-grid">';

            activeDays.forEach(day => {
                const dayAssignment = monthAssignments[day.date] || { tea: [], car: [] };

                // å¸Œæœ›è€…é›†è¨ˆ
                const teaAvailable = [];
                const carAvailable = [];
                Object.keys(preferences).forEach(parent => {
                    const monthPrefs = preferences[parent][month] || {};
                    const dayPref = monthPrefs[day.date];
                    if (dayPref === 'both' || dayPref === 'tea_only') {
                        teaAvailable.push(parent);
                    }
                    if (dayPref === 'both' || dayPref === 'car_only') {
                        carAvailable.push(parent);
                    }
                });

                html += `<div class="assignment-card">`;
                html += `<h4>${day.display}</h4>`;
                
                // ãŠèŒ¶å½“ç•ª
                html += `<div style="margin-top: 15px;">`;
                html += `<strong>ãŠèŒ¶å½“ç•ª:</strong> <span style="font-size: 12px; color: #666;">(å¯èƒ½: ${teaAvailable.join(', ') || 'ãªã—'})</span><br>`;
                html += `<select multiple style="width: 100%; height: 80px; margin-top: 5px;" id="tea_${day.date}">`;
                parents.forEach(parent => {
                    const selected = dayAssignment.tea.includes(parent) ? 'selected' : '';
                    const available = teaAvailable.includes(parent);
                    html += `<option value="${parent}" ${selected} ${!available ? 'style="color: #ccc;"' : ''}>${parent}${!available ? ' (å¸Œæœ›ãªã—)' : ''}</option>`;
                });
                html += `</select>`;
                html += `</div>`;

                // è»Šå½“ç•ª
                html += `<div style="margin-top: 15px;">`;
                html += `<strong>è»Šå½“ç•ª:</strong> <span style="font-size: 12px; color: #666;">(å¯èƒ½: ${carAvailable.join(', ') || 'ãªã—'})</span><br>`;
                html += `<select multiple style="width: 100%; height: 80px; margin-top: 5px;" id="car_${day.date}">`;
                parents.forEach(parent => {
                    const selected = dayAssignment.car.includes(parent) ? 'selected' : '';
                    const available = carAvailable.includes(parent);
                    html += `<option value="${parent}" ${selected} ${!available ? 'style="color: #ccc;"' : ''}>${parent}${!available ? ' (å¸Œæœ›ãªã—)' : ''}</option>`;
                });
                html += `</select>`;
                html += `</div>`;

                html += `</div>`;
            });

            html += '</div>';
            html += '<button class="btn btn-primary" onclick="saveAssignments()" style="margin-top: 20px;">å‰²ã‚Šå½“ã¦ã‚’ä¿å­˜</button>';

            document.getElementById('assignmentContent').innerHTML = html;
        }

        // å‰²ã‚Šå½“ã¦ä¿å­˜
        function saveAssignments() {
            const month = document.getElementById('assignmentMonth').value;
            if (!month) return;

            const [year, monthNum] = month.split('-').map(Number);
            const weekends = getWeekendsAndHolidays(year, monthNum);
            const practiceDays = getPracticeDays(month);
            const activeDays = weekends.filter(w => practiceDays.includes(w.date));

            const assignments = getData(STORAGE_KEYS.assignments) || {};
            if (!assignments[month]) {
                assignments[month] = {};
            }

            activeDays.forEach(day => {
                const teaSelect = document.getElementById(`tea_${day.date}`);
                const carSelect = document.getElementById(`car_${day.date}`);

                if (teaSelect && carSelect) {
                    assignments[month][day.date] = {
                        tea: Array.from(teaSelect.selectedOptions).map(opt => opt.value),
                        car: Array.from(carSelect.selectedOptions).map(opt => opt.value)
                    };
                }
            });

            saveData(STORAGE_KEYS.assignments, assignments);
            alert('å‰²ã‚Šå½“ã¦ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        // è‡ªå‹•å‰²ã‚Šå½“ã¦
        function autoAssign() {
            const month = document.getElementById('assignmentMonth').value;
            if (!month) return;

            if (!confirm('è‡ªå‹•å‰²ã‚Šå½“ã¦ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®å‰²ã‚Šå½“ã¦ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
                return;
            }

            const [year, monthNum] = month.split('-').map(Number);
            const weekends = getWeekendsAndHolidays(year, monthNum);
            const practiceDays = getPracticeDays(month);
            const activeDays = weekends.filter(w => practiceDays.includes(w.date));

            const preferences = getData(STORAGE_KEYS.preferences) || {};
            const parents = getData(STORAGE_KEYS.parents) || [];

            const assignments = {};
            const teaCount = {};
            const carCount = {};
            parents.forEach(p => {
                teaCount[p] = 0;
                carCount[p] = 0;
            });

            activeDays.forEach(day => {
                // ãŠèŒ¶å½“ç•ªã®å‰²ã‚Šå½“ã¦ï¼ˆå¯èƒ½ãªäººã‹ã‚‰1-2åï¼‰
                const teaAvailable = [];
                Object.keys(preferences).forEach(parent => {
                    const monthPrefs = preferences[parent][month] || {};
                    const dayPref = monthPrefs[day.date];
                    if (dayPref === 'both' || dayPref === 'tea_only') {
                        teaAvailable.push(parent);
                    }
                });

                // ã‚«ã‚¦ãƒ³ãƒˆãŒå°‘ãªã„é †ã«ã‚½ãƒ¼ãƒˆ
                teaAvailable.sort((a, b) => teaCount[a] - teaCount[b]);
                const selectedTea = teaAvailable.slice(0, 2);
                selectedTea.forEach(p => teaCount[p]++);

                // è»Šå½“ç•ªã®å‰²ã‚Šå½“ã¦ï¼ˆå¯èƒ½ãªäººã‹ã‚‰2-3åï¼‰
                const carAvailable = [];
                Object.keys(preferences).forEach(parent => {
                    const monthPrefs = preferences[parent][month] || {};
                    const dayPref = monthPrefs[day.date];
                    if (dayPref === 'both' || dayPref === 'car_only') {
                        carAvailable.push(parent);
                    }
                });

                carAvailable.sort((a, b) => carCount[a] - carCount[b]);
                const selectedCar = carAvailable.slice(0, 3);
                selectedCar.forEach(p => carCount[p]++);

                assignments[day.date] = {
                    tea: selectedTea,
                    car: selectedCar
                };
            });

            // ä¿å­˜
            const allAssignments = getData(STORAGE_KEYS.assignments) || {};
            allAssignments[month] = assignments;
            saveData(STORAGE_KEYS.assignments, allAssignments);

            loadAssignmentView();
            alert('è‡ªå‹•å‰²ã‚Šå½“ã¦ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§èª¿æ•´ã—ã¦ãã ã•ã„ã€‚');
        }

        // è»Šä¸¡å‰²ã‚Šå½“ã¦è¡¨ç¤º
        function loadCarAssignmentView() {
            const month = document.getElementById('carAssignmentMonth').value;
            if (!month) return;

            const [year, monthNum] = month.split('-').map(Number);
            const weekends = getWeekendsAndHolidays(year, monthNum);
            const practiceDays = getPracticeDays(month);
            const activeDays = weekends.filter(w => practiceDays.includes(w.date));

            const assignments = getData(STORAGE_KEYS.assignments) || {};
            const monthAssignments = assignments[month] || {};
            const absences = getData(STORAGE_KEYS.absences) || [];
            const members = getData(STORAGE_KEYS.members) || [];
            const vehicles = getData(STORAGE_KEYS.vehicles) || [];
            const relations = getData(STORAGE_KEYS.parent_child_relations) || {};
            const siblingsCount = getData(STORAGE_KEYS.siblings_count) || {};

            if (activeDays.length === 0) {
                document.getElementById('carAssignmentContent').innerHTML = 
                    '<p class="info-text">ã“ã®æœˆã®ç·´ç¿’æ—¥ã¯ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            let html = '<button class="btn btn-success" onclick="autoAssignCars()" style="margin-bottom: 20px;">è‡ªå‹•å‰²ã‚Šå½“ã¦</button>';
            html += '<p class="info-text">å„è»Šä¸¡ã«ä¹—è»Šã™ã‚‹éƒ¨å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚è‡ªå‹•å‰²ã‚Šå½“ã¦ãƒœã‚¿ãƒ³ã§è¦ªå­é–¢ä¿‚ã¨å®šå“¡ã‚’è€ƒæ…®ã—ãŸå‰²ã‚Šå½“ã¦ã‚’ææ¡ˆã—ã¾ã™ã€‚</p>';
            html += '<div class="assignment-grid">';

            activeDays.forEach(day => {
                const dayAssignment = monthAssignments[day.date] || { tea: [], car: [] };
                const carDrivers = dayAssignment.car || [];

                // æ¬ å¸­è€…ã‚’å–å¾—
                const dayAbsence = absences.find(a => a.date === day.date);
                const absentMembers = dayAbsence ? dayAbsence.members : [];
                const attendingMembers = members.filter(m => !absentMembers.includes(m));

                html += `<div class="assignment-card">`;
                html += `<h4>${day.display}</h4>`;
                html += `<p style="font-size: 14px; color: #666;">å‡ºå¸­éƒ¨å“¡: ${attendingMembers.length}å</p>`;

                if (carDrivers.length === 0) {
                    html += `<p style="color: #e74c3c;">è»Šå½“ç•ªãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>`;
                } else {
                    carDrivers.forEach(driver => {
                        const vehicle = vehicles.find(v => v.parent === driver);
                        const capacity = vehicle ? vehicle.capacity : 4;
                        const siblings = siblingsCount[driver] || 0;
                        const availableSeats = capacity - siblings;

                        html += `<div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px; background: #f9f9f9;">`;
                        html += `<strong>${driver}ã®è»Š</strong> `;
                        html += `<span style="font-size: 12px; color: #666;">(å®šå“¡: ${capacity}å, å…„å¼Ÿå§‰å¦¹: ${siblings}å, ç©ºå¸­: ${availableSeats}å)</span><br>`;
                        html += `<select multiple style="width: 100%; height: 100px; margin-top: 5px;" id="car_${day.date}_${driver}">`;
                        attendingMembers.forEach(member => {
                            html += `<option value="${member}">${member}</option>`;
                        });
                        html += `</select>`;
                        html += `</div>`;
                    });
                }

                html += `</div>`;
            });

            html += '</div>';
            html += '<button class="btn btn-primary" onclick="saveCarAssignments()" style="margin-top: 20px;">å‰²ã‚Šå½“ã¦ã‚’ä¿å­˜</button>';

            document.getElementById('carAssignmentContent').innerHTML = html;
        }

        // è»Šä¸¡å‰²ã‚Šå½“ã¦ã®è‡ªå‹•ææ¡ˆ
        function autoAssignCars() {
            const month = document.getElementById('carAssignmentMonth').value;
            if (!month) return;

            if (!confirm('è‡ªå‹•å‰²ã‚Šå½“ã¦ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®å‰²ã‚Šå½“ã¦ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
                return;
            }

            const [year, monthNum] = month.split('-').map(Number);
            const weekends = getWeekendsAndHolidays(year, monthNum);
            const practiceDays = getPracticeDays(month);
            const activeDays = weekends.filter(w => practiceDays.includes(w.date));

            const assignments = getData(STORAGE_KEYS.assignments) || {};
            const monthAssignments = assignments[month] || {};
            const absences = getData(STORAGE_KEYS.absences) || [];
            const members = getData(STORAGE_KEYS.members) || [];
            const vehicles = getData(STORAGE_KEYS.vehicles) || [];
            const relations = getData(STORAGE_KEYS.parent_child_relations) || {};
            const siblingsCount = getData(STORAGE_KEYS.siblings_count) || {};

            activeDays.forEach(day => {
                const dayAssignment = monthAssignments[day.date] || { tea: [], car: [] };
                const carDrivers = dayAssignment.car || [];

                // æ¬ å¸­è€…ã‚’é™¤å¤–
                const dayAbsence = absences.find(a => a.date === day.date);
                const absentMembers = dayAbsence ? dayAbsence.members : [];
                const attendingMembers = members.filter(m => !absentMembers.includes(m));

                // å„è»Šä¸¡ã«å‰²ã‚Šå½“ã¦
                const carAssignments = {};
                const assignedMembers = new Set();

                // ã¾ãšã€è‡ªåˆ†ã®å­ä¾›ã‚’è‡ªåˆ†ã®è»Šã«å‰²ã‚Šå½“ã¦
                carDrivers.forEach(driver => {
                    carAssignments[driver] = [];
                    attendingMembers.forEach(member => {
                        if (relations[member] === driver && !assignedMembers.has(member)) {
                            carAssignments[driver].push(member);
                            assignedMembers.add(member);
                        }
                    });
                });

                // æ®‹ã‚Šã®éƒ¨å“¡ã‚’å®šå“¡ã«ä½™è£•ãŒã‚ã‚‹è»Šã«å‰²ã‚Šå½“ã¦
                const unassignedMembers = attendingMembers.filter(m => !assignedMembers.has(m));
                
                unassignedMembers.forEach(member => {
                    // å„è»Šã®ç¾åœ¨ã®ä¹—è»Šäººæ•°ï¼ˆéƒ¨å“¡+å…„å¼Ÿå§‰å¦¹ï¼‰ã‚’è¨ˆç®—
                    let bestDriver = null;
                    let maxAvailable = -1;

                    carDrivers.forEach(driver => {
                        const vehicle = vehicles.find(v => v.parent === driver);
                        const capacity = vehicle ? vehicle.capacity : 4;
                        const siblings = siblingsCount[driver] || 0;
                        const currentLoad = carAssignments[driver].length + siblings;
                        const available = capacity - currentLoad;

                        if (available > maxAvailable) {
                            maxAvailable = available;
                            bestDriver = driver;
                        }
                    });

                    if (bestDriver && maxAvailable > 0) {
                        carAssignments[bestDriver].push(member);
                    }
                });

                // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«åæ˜ 
                carDrivers.forEach(driver => {
                    const select = document.getElementById(`car_${day.date}_${driver}`);
                    if (select) {
                        // å…¨ã¦ã®é¸æŠã‚’è§£é™¤
                        Array.from(select.options).forEach(option => {
                            option.selected = false;
                        });
                        // å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸéƒ¨å“¡ã‚’é¸æŠ
                        carAssignments[driver].forEach(member => {
                            Array.from(select.options).forEach(option => {
                                if (option.value === member) {
                                    option.selected = true;
                                }
                            });
                        });
                    }
                });
            });

            alert('è‡ªå‹•å‰²ã‚Šå½“ã¦ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§èª¿æ•´ã—ã¦ãã ã•ã„ã€‚');
        }

        // è»Šä¸¡å‰²ã‚Šå½“ã¦ã‚’ä¿å­˜
        function saveCarAssignments() {
            const month = document.getElementById('carAssignmentMonth').value;
            if (!month) return;

            const [year, monthNum] = month.split('-').map(Number);
            const weekends = getWeekendsAndHolidays(year, monthNum);
            const practiceDays = getPracticeDays(month);
            const activeDays = weekends.filter(w => practiceDays.includes(w.date));

            const assignments = getData(STORAGE_KEYS.assignments) || {};
            const monthAssignments = assignments[month] || {};

            const carAssignments = getData(STORAGE_KEYS.car_assignments) || {};
            if (!carAssignments[month]) {
                carAssignments[month] = {};
            }

            activeDays.forEach(day => {
                const dayAssignment = monthAssignments[day.date] || { tea: [], car: [] };
                const carDrivers = dayAssignment.car || [];

                carAssignments[month][day.date] = {};

                carDrivers.forEach(driver => {
                    const select = document.getElementById(`car_${day.date}_${driver}`);
                    if (select) {
                        carAssignments[month][day.date][driver] = Array.from(select.selectedOptions).map(opt => opt.value);
                    }
                });
            });

            saveData('baseball_car_assignments', carAssignments);
            alert('è»Šä¸¡å‰²ã‚Šå½“ã¦ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        // ç·åˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º
        function loadScheduleView() {
            const month = document.getElementById('scheduleMonth').value;
            if (!month) return;

            const [year, monthNum] = month.split('-').map(Number);
            const weekends = getWeekendsAndHolidays(year, monthNum);
            const practiceDays = getPracticeDays(month);
            const activeDays = weekends.filter(w => practiceDays.includes(w.date));

            const grounds = getData(STORAGE_KEYS.grounds) || [];
            const assignments = getData(STORAGE_KEYS.assignments) || {};
            const absences = getData(STORAGE_KEYS.absences) || [];
            const vehicles = getData(STORAGE_KEYS.vehicles) || [];
            const members = getData(STORAGE_KEYS.members) || [];
            const carAssignments = getData('baseball_car_assignments') || {};
            const siblingsCount = getData(STORAGE_KEYS.siblings_count) || {};

            if (activeDays.length === 0) {
                document.getElementById('scheduleContent').innerHTML = 
                    '<p class="info-text">ã“ã®æœˆã®ç·´ç¿’æ—¥ã¯ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            const monthAssignments = assignments[month] || {};
            const monthCarAssignments = carAssignments[month] || {};

            let html = '<table>';
            html += '<thead><tr>';
            html += '<th>æ—¥ä»˜</th>';
            html += '<th>ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æƒ…å ±</th>';
            html += '<th>ãŠèŒ¶å½“ç•ª</th>';
            html += '<th>è»Šå½“ç•ª</th>';
            html += '<th>æ¬ å¸­è€…</th>';
            html += '<th>å‡ºå¸­äººæ•°</th>';
            html += '</tr></thead><tbody>';

            activeDays.forEach(day => {
                const assignment = monthAssignments[day.date] || { tea: [], car: [] };
                const dayAbsences = absences.find(a => a.date === day.date);
                const absentMembers = dayAbsences ? dayAbsences.members : [];
                const attendCount = members.length - absentMembers.length;

                // ãã®æ—¥ã®ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æƒ…å ±ã‚’å–å¾—
                const dayGrounds = grounds.filter(g => g.date === day.date);
                const groundInfo = dayGrounds.length > 0 
                    ? dayGrounds.map(g => `${g.timeStart}-${g.timeEnd} ${g.location}`).join('<br>')
                    : '-';

                html += '<tr>';
                html += `<td><strong>${day.display}</strong></td>`;
                html += `<td>${groundInfo}</td>`;
                html += `<td>${assignment.tea.join('<br>') || '-'}</td>`;
                html += `<td>${assignment.car.join('<br>') || '-'}</td>`;
                html += `<td>${absentMembers.join(', ') || '-'}</td>`;
                html += `<td>${attendCount}å</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';

            // è»Šä¸¡ä¹—è»Šè¨ˆç”»ã®è©³ç´°
            html += '<div class="summary-card" style="margin-top: 20px;">';
            html += '<h3>è»Šä¸¡ä¹—è»Šè¨ˆç”»</h3>';
            activeDays.forEach(day => {
                const assignment = monthAssignments[day.date] || { tea: [], car: [] };
                const dayAbsences = absences.find(a => a.date === day.date);
                const absentMembers = dayAbsences ? dayAbsences.members : [];
                const attendCount = members.length - absentMembers.length;
                const dayCarAssignment = monthCarAssignments[day.date] || {};

                let totalCapacity = 0;
                let totalAssigned = 0;

                html += `<div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px;">`;
                html += `<h4 style="margin-bottom: 10px;">${day.display}</h4>`;

                assignment.car.forEach(driver => {
                    const vehicle = vehicles.find(v => v.parent === driver);
                    const capacity = vehicle ? vehicle.capacity : 4;
                    const siblings = siblingsCount[driver] || 0;
                    const assignedMembers = dayCarAssignment[driver] || [];
                    const totalLoad = assignedMembers.length + siblings;
                    totalCapacity += capacity;
                    totalAssigned += assignedMembers.length;

                    const statusColor = totalLoad <= capacity ? 'green' : 'red';
                    
                    html += `<div style="margin: 10px 0; padding: 10px; background: #f9f9f9; border-left: 4px solid ${statusColor};">`;
                    html += `<strong>${driver}</strong> `;
                    html += `<span style="font-size: 12px;">(å®šå“¡${capacity}å / å…„å¼Ÿå§‰å¦¹${siblings}å / éƒ¨å“¡${assignedMembers.length}å / åˆè¨ˆ${totalLoad}å)</span><br>`;
                    if (assignedMembers.length > 0) {
                        html += `<span style="font-size: 14px; color: #666;">ä¹—è»Š: ${assignedMembers.join(', ')}</span>`;
                    } else {
                        html += `<span style="font-size: 14px; color: #999;">å‰²ã‚Šå½“ã¦ãªã—</span>`;
                    }
                    html += `</div>`;
                });

                const status = totalCapacity >= attendCount ? 'âœ“ OK' : 'âš  å®šå“¡ä¸è¶³';
                const color = totalCapacity >= attendCount ? 'green' : 'red';

                html += `<p style="margin-top: 10px; font-weight: bold;">`;
                html += `å‡ºå¸­${attendCount}å / å‰²ã‚Šå½“ã¦æ¸ˆ${totalAssigned}å / ç·å®šå“¡${totalCapacity}å `;
                html += `<span style="color: ${color};">${status}</span>`;
                html += `</p>`;
                html += `</div>`;
            });
            html += '</div>';

            document.getElementById('scheduleContent').innerHTML = html;
        }

        // å…¥åŠ›å—ä»˜å¯¾è±¡æœˆã‚’è¨­å®š
        function setInputTargetMonth() {
            const month = document.getElementById('inputTargetMonth').value;
            if (!month) {
                alert('æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            saveData(STORAGE_KEYS.input_target_month, month);
            alert(`${month}ã‚’å…¥åŠ›å—ä»˜å¯¾è±¡æœˆã«è¨­å®šã—ã¾ã—ãŸ`);
            loadSettings();
        }

        // å…¥åŠ›å—ä»˜ã‚’åœæ­¢
        function clearInputTargetMonth() {
            if (!confirm('å…¥åŠ›å—ä»˜ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿä¿è­·è€…ã¯å¸Œæœ›æ—¥ã‚’å…¥åŠ›ã§ããªããªã‚Šã¾ã™ã€‚')) {
                return;
            }

            localStorage.removeItem(STORAGE_KEYS.input_target_month);
            alert('å…¥åŠ›å—ä»˜ã‚’åœæ­¢ã—ã¾ã—ãŸ');
            loadSettings();
        }

        // Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testFirebaseConnection() {
            if (!firebaseInitialized) {
                alert('Firebaseè¨­å®šãŒæœªè¨­å®šã§ã™ã€‚HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®FIREBASE_CONFIGã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                await db.collection('baseball_data').doc('test').set({
                    test: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('âœ… Firebaseæ¥ç¶šæˆåŠŸï¼ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨å–å¾—ãŒã§ãã¾ã™ã€‚');
            } catch (error) {
                console.error('Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´
        function changeStorageMode() {
            const mode = document.getElementById('storageMode').value;
            
            if (mode === 'firebase' && !firebaseInitialized) {
                alert('Firebaseè¨­å®šãŒæœªè¨­å®šã§ã™ã€‚HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®FIREBASE_CONFIGã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                document.getElementById('storageMode').value = 'local';
                return;
            }

            localStorage.setItem(STORAGE_KEYS.storage_mode, mode);
            
            if (mode === 'firebase') {
                document.getElementById('syncButton').style.display = 'inline-block';
                alert('Firebaseãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚ä¿è­·è€…ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã§å…±æœ‰ã•ã‚Œã¾ã™ã€‚');
            } else {
                document.getElementById('syncButton').style.display = 'none';
                alert('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã¯å„è‡ªã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚');
            }
            
            updateFirebaseStatus();
        }

        // Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ
        async function syncFromFirebase() {
            if (!firebaseInitialized) {
                alert('FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            try {
                // ä¿è­·è€…ã®å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const doc = await db.collection('baseball_data').doc(STORAGE_KEYS.preferences).get();
                
                if (doc.exists) {
                    const data = doc.data().data;
                    localStorage.setItem(STORAGE_KEYS.preferences, JSON.stringify(data));
                    alert('Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ');
                    
                    // ç”»é¢ã‚’å†èª­ã¿è¾¼ã¿
                    if (currentRole === 'admin') {
                        loadSettings();
                    }
                } else {
                    alert('Firebaseã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // FirebaseçŠ¶æ…‹ã‚’æ›´æ–°
        function updateFirebaseStatus() {
            const statusDiv = document.getElementById('firebaseStatus');
            const mode = localStorage.getItem(STORAGE_KEYS.storage_mode) || 'local';
            
            let html = '<div style="padding: 10px; border-radius: 5px; margin-bottom: 15px; ';
            
            if (firebaseInitialized && mode === 'firebase') {
                html += 'background: #d4edda; color: #155724;">';
                html += '<strong>âœ… Firebaseé€£æº: æœ‰åŠ¹</strong><br>';
                html += '<small>ä¿è­·è€…ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åé›†ã•ã‚Œã¾ã™</small>';
            } else if (firebaseInitialized && mode === 'local') {
                html += 'background: #fff3cd; color: #856404;">';
                html += '<strong>âš ï¸ Firebaseé€£æº: åˆ©ç”¨å¯èƒ½ï¼ˆç¾åœ¨ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼‰</strong><br>';
                html += '<small>Firebaseãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã§ãã¾ã™</small>';
            } else {
                html += 'background: #f8d7da; color: #721c24;">';
                html += '<strong>âŒ Firebaseé€£æº: æœªè¨­å®š</strong><br>';
                html += '<small>HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®FIREBASE_CONFIGã‚’è¨­å®šã—ã¦ãã ã•ã„</small>';
            }
            
            html += '</div>';
            statusDiv.innerHTML = html;
        }

        // è¨­å®šç”»é¢èª­ã¿è¾¼ã¿
        async function loadSettings() {
            const parents = await getData(STORAGE_KEYS.parents) || [];
            const members = await getData(STORAGE_KEYS.members) || [];
            const targetMonth = await getData(STORAGE_KEYS.input_target_month);
            const relations = await getData(STORAGE_KEYS.parent_child_relations) || {};
            const siblingsCount = await getData(STORAGE_KEYS.siblings_count) || {};
            const storageMode = localStorage.getItem(STORAGE_KEYS.storage_mode) || 'local';

            // FirebaseçŠ¶æ…‹ã‚’æ›´æ–°
            updateFirebaseStatus();
            
            // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
            document.getElementById('storageMode').value = storageMode;
            if (storageMode === 'firebase') {
                document.getElementById('syncButton').style.display = 'inline-block';
            }

            // å…¥åŠ›å—ä»˜å¯¾è±¡æœˆã®è¡¨ç¤º
            const targetMonthDiv = document.getElementById('currentInputTargetMonth');
            if (targetMonth) {
                const [year, month] = targetMonth.split('-');
                targetMonthDiv.innerHTML = `<p style="padding: 10px; background: #d4edda; color: #155724; border-radius: 5px; font-weight: bold;">ç¾åœ¨ã®å—ä»˜å¯¾è±¡æœˆ: ${year}å¹´${month}æœˆ</p>`;
            } else {
                targetMonthDiv.innerHTML = `<p style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 5px; font-weight: bold;">ç¾åœ¨ã€å…¥åŠ›å—ä»˜ã¯åœæ­¢ä¸­ã§ã™</p>`;
            }

            // ä¿è­·è€…ãƒªã‚¹ãƒˆ
            let parentHtml = '<ul style="list-style: none; padding: 0; margin-top: 15px;">';
            parents.forEach(parent => {
                parentHtml += `
                    <li style="padding: 10px; background: white; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                        <span>${parent}</span>
                        <button class="delete-btn" onclick="deleteParent('${parent}')">å‰Šé™¤</button>
                    </li>
                `;
            });
            parentHtml += '</ul>';
            document.getElementById('parentList').innerHTML = parentHtml;

            // éƒ¨å“¡ãƒªã‚¹ãƒˆ
            let memberHtml = '<ul style="list-style: none; padding: 0; margin-top: 15px;">';
            members.forEach(member => {
                memberHtml += `
                    <li style="padding: 10px; background: white; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                        <span>${member}</span>
                        <button class="delete-btn" onclick="deleteMember('${member}')">å‰Šé™¤</button>
                    </li>
                `;
            });
            memberHtml += '</ul>';
            document.getElementById('memberList').innerHTML = memberHtml;

            // è¦ªå­é–¢ä¿‚ãƒªã‚¹ãƒˆ
            let relationHtml = '<table style="margin-top: 15px;"><thead><tr><th>éƒ¨å“¡å</th><th>ä¿è­·è€…</th></tr></thead><tbody>';
            members.forEach(member => {
                const parent = relations[member] || '';
                relationHtml += `<tr>`;
                relationHtml += `<td><strong>${member}</strong></td>`;
                relationHtml += `<td><select id="parent_of_${member}" style="width: 100%; padding: 5px;">`;
                relationHtml += `<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>`;
                parents.forEach(p => {
                    relationHtml += `<option value="${p}" ${parent === p ? 'selected' : ''}>${p}</option>`;
                });
                relationHtml += `</select></td>`;
                relationHtml += `</tr>`;
            });
            relationHtml += '</tbody></table>';
            relationHtml += '<button class="btn btn-primary" onclick="saveParentChildRelations()" style="margin-top: 15px;">ä¿å­˜</button>';
            document.getElementById('parentChildRelationList').innerHTML = relationHtml;

            // å…„å¼Ÿå§‰å¦¹äººæ•°ãƒªã‚¹ãƒˆ
            let siblingsHtml = '<table style="margin-top: 15px;"><thead><tr><th>ä¿è­·è€…å</th><th>åŒä¹—ã™ã‚‹å…„å¼Ÿå§‰å¦¹ã®äººæ•°</th></tr></thead><tbody>';
            parents.forEach(parent => {
                const count = siblingsCount[parent] || 0;
                siblingsHtml += `<tr>`;
                siblingsHtml += `<td><strong>${parent}</strong></td>`;
                siblingsHtml += `<td><input type="number" id="siblings_${parent}" min="0" max="10" value="${count}" style="width: 100px; padding: 5px;">å</td>`;
                siblingsHtml += `</tr>`;
            });
            siblingsHtml += '</tbody></table>';
            siblingsHtml += '<button class="btn btn-primary" onclick="saveSiblingsCount()" style="margin-top: 15px;">ä¿å­˜</button>';
            document.getElementById('siblingsCountList').innerHTML = siblingsHtml;
        }

        // è¦ªå­é–¢ä¿‚ã‚’ä¿å­˜
        function saveParentChildRelations() {
            const members = getData(STORAGE_KEYS.members) || [];
            const relations = {};

            members.forEach(member => {
                const select = document.getElementById(`parent_of_${member}`);
                if (select && select.value) {
                    relations[member] = select.value;
                }
            });

            saveData(STORAGE_KEYS.parent_child_relations, relations);
            alert('è¦ªå­é–¢ä¿‚ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        // å…„å¼Ÿå§‰å¦¹äººæ•°ã‚’ä¿å­˜
        function saveSiblingsCount() {
            const parents = getData(STORAGE_KEYS.parents) || [];
            const siblingsCount = {};

            parents.forEach(parent => {
                const input = document.getElementById(`siblings_${parent}`);
                if (input) {
                    siblingsCount[parent] = parseInt(input.value) || 0;
                }
            });

            saveData(STORAGE_KEYS.siblings_count, siblingsCount);
            alert('å…„å¼Ÿå§‰å¦¹äººæ•°ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        // Excelã‹ã‚‰ä¿è­·è€…åç°¿ã‚’èª­ã¿è¾¼ã¿
        function importParentsFromExcel() {
            const fileInput = document.getElementById('parentExcelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’å–å¾—
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    console.log('èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿:', jsonData);
                    
                    // åå‰ã‚’æŠ½å‡ºï¼ˆç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
                    const names = [];
                    jsonData.forEach((row, index) => {
                        if (row[0] && typeof row[0] === 'string') {
                            const name = row[0].trim();
                            if (name && name !== 'ä¿è­·è€…å' && name !== 'åå‰') {
                                names.push(name);
                            }
                        }
                    });
                    
                    console.log('æŠ½å‡ºã—ãŸåå‰:', names);
                    
                    if (names.length === 0) {
                        alert('æœ‰åŠ¹ãªåå‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                        return;
                    }

                    // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã¨çµ±åˆï¼ˆé‡è¤‡ã‚’é™¤ãï¼‰
                    let parents = await getData(STORAGE_KEYS.parents) || [];
                    names.forEach(name => {
                        if (!parents.includes(name)) {
                            parents.push(name);
                        }
                    });
                    
                    await saveData(STORAGE_KEYS.parents, parents);
                    alert(`${names.length}åã®ä¿è­·è€…ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                    fileInput.value = '';
                    await loadSettings();
                    
                } catch (error) {
                    console.error('Excelèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Excelã‹ã‚‰éƒ¨å“¡åç°¿ã‚’èª­ã¿è¾¼ã¿
        function importMembersFromExcel() {
            const fileInput = document.getElementById('memberExcelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’å–å¾—
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    console.log('èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿:', jsonData);
                    
                    // åå‰ã‚’æŠ½å‡ºï¼ˆç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
                    const names = [];
                    jsonData.forEach((row, index) => {
                        if (row[0] && typeof row[0] === 'string') {
                            const name = row[0].trim();
                            if (name && name !== 'éƒ¨å“¡å' && name !== 'åå‰') {
                                names.push(name);
                            }
                        }
                    });
                    
                    console.log('æŠ½å‡ºã—ãŸåå‰:', names);
                    
                    if (names.length === 0) {
                        alert('æœ‰åŠ¹ãªåå‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                        return;
                    }

                    // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã¨çµ±åˆï¼ˆé‡è¤‡ã‚’é™¤ãï¼‰
                    let members = await getData(STORAGE_KEYS.members) || [];
                    names.forEach(name => {
                        if (!members.includes(name)) {
                            members.push(name);
                        }
                    });
                    
                    await saveData(STORAGE_KEYS.members, members);
                    alert(`${names.length}åã®éƒ¨å“¡ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                    fileInput.value = '';
                    await loadSettings();
                    
                } catch (error) {
                    console.error('Excelèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ä¿è­·è€…è¿½åŠ 
        async function addParent() {
            const name = document.getElementById('newParentName').value.trim();
            if (!name) {
                alert('ä¿è­·è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const parents = await getData(STORAGE_KEYS.parents) || [];
            if (parents.includes(name)) {
                alert('æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }

            parents.push(name);
            await saveData(STORAGE_KEYS.parents, parents);
            document.getElementById('newParentName').value = '';
            await loadSettings();
        }

        // ä¿è­·è€…å‰Šé™¤
        async function deleteParent(name) {
            if (!confirm(`${name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            let parents = await getData(STORAGE_KEYS.parents) || [];
            parents = parents.filter(p => p !== name);
            await saveData(STORAGE_KEYS.parents, parents);
            await loadSettings();
        }

        // éƒ¨å“¡è¿½åŠ 
        async function addMember() {
            const name = document.getElementById('newMemberName').value.trim();
            if (!name) {
                alert('éƒ¨å“¡åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const members = await getData(STORAGE_KEYS.members) || [];
            if (members.includes(name)) {
                alert('æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }

            members.push(name);
            await saveData(STORAGE_KEYS.members, members);
            document.getElementById('newMemberName').value = '';
            await loadSettings();
        }

        // éƒ¨å“¡å‰Šé™¤
        async function deleteMember(name) {
            if (!confirm(`${name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            let members = await getData(STORAGE_KEYS.members) || [];
            members = members.filter(m => m !== name);
            await saveData(STORAGE_KEYS.members, members);
            await loadSettings();
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (!confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            if (!confirm('æœ€çµ‚ç¢ºèªï¼šå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }

            Object.values(STORAGE_KEYS).forEach(key => {
                localStorage.removeItem(key);
            });

            alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            logout();
            init();
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.onload = init;
    </script>
</body>
</html>
